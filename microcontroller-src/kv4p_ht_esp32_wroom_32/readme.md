# KV4P-HT Serial Interface Documentation

This document provides detailed instructions on how to interact with the KV4P-HT device via its serial console. It covers the serial connection setup, communication protocol, and command usage, including changing frequencies, controlling Push-To-Talk (PTT), and configuring filters.

---

## Table of Contents

1. [Serial Connection Setup](#1-serial-connection-setup)
2. [Communication Protocol](#2-communication-protocol)
   - [2.1. Delimiter](#21-delimiter)
   - [2.2. Command Structure](#22-command-structure)
3. [Commands from Android (to ESP32)](#3-commands)
   - [3.1. COMMAND_PTT_DOWN (0x01)](#31-command_ptt_down-0x01)
   - [3.2. COMMAND_PTT_UP (0x02)](#32-command_ptt_up-0x02)
   - [3.3. COMMAND_TUNE_TO (0x03)](#33-command_tune_to-0x03)
   - [3.4. COMMAND_FILTERS (0x04)](#34-command_filters-0x04)
   - [3.5. COMMAND_STOP (0x05)](#35-command_stop-0x05)
   - [3.6. COMMAND_GET_FIRMWARE_VER (0x06)](#36-command_get_firmware_ver-0x06)
4. [Commands from ESP32 (to Android)](#4-esp32-commands)
   - [4.1. COMMAND_SMETER (0x53)](#41-command_smeter-0x53)
5. [Examples](#5-examples)
   - [5.1. Changing Frequencies](#51-changing-frequencies)
   - [5.2. Starting Transmission](#52-starting-transmission)
   - [5.3. Stopping Transmission](#53-stopping-transmission)
   - [5.4. Configuring Filters](#54-configuring-filters)
   - [5.5. Retrieving Firmware Version](#55-retrieving-firmware-version)
6. [Additional Notes](#6-additional-notes)

---

## 1. Serial Connection Setup

To interact with the KV4P-HT device, establish a serial connection using the following parameters:

- **Port**: The serial port connected to the KV4P-HT device (e.g., `COM3`, `/dev/ttyUSB0`).
- **Baud Rate**: `230400` bits per second.
- **Data Bits**: `8` bits.
- **Parity**: `None`.
- **Stop Bits**: `1` bit.
- **Flow Control**: `None`.

**Note**: Ensure that your serial communication software or terminal emulator supports the high baud rate of 921600 bps.

---

## 2. Communication Protocol

### 2.1. Delimiter

All commands sent to the KV4P-HT device must be preceded by an 8-byte delimiter. This delimiter signals the start of a new command and helps synchronize communication.

**Delimiter Byte Sequence**:

```plaintext
0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00
```

### 2.2. Command Structure

After the delimiter, send a single-byte command code followed by any required parameters. The general structure is as follows:

```plaintext
[Delimiter][Command Code][Parameters (if any)]
```

- **Delimiter**: 8 bytes (as specified above).
- **Command Code**: 1 byte (see the list of commands below).
- **Parameters**: Varies by command.

---

## 3. Commands from Android (to ESP32)

Below is a list of commands supported by the KV4P-HT device, along with their descriptions and parameter requirements.

### 3.1. COMMAND_PTT_DOWN (0x01)

- **Description**: Initiates transmission mode. The device expects audio data to follow, which will be transmitted over the radio.
- **Parameters**: None.
- **Usage**:
  - Send the delimiter.
  - Send the command code `0x01`.

### 3.2. COMMAND_PTT_UP (0x02)

- **Description**: Stops transmission and returns the device to receive mode.
- **Parameters**: None.
- **Usage**:
  - Send the delimiter.
  - Send the command code `0x02`.

### 3.3. COMMAND_TUNE_TO (0x03)

- **Description**: Changes the transmit and receive frequencies, as well as the tone and squelch settings.
- **Parameters**: 19 bytes total.
  - **Transmit Frequency**: 8 ASCII characters (e.g., `146.5200`).
  - **Receive Frequency**: 8 ASCII characters.
  - **Tone**: 2 ASCII characters representing an integer (e.g., `00` for none).
  - **Squelch**: 1 ASCII character (`0` thru `8`).
  - **Bandwidth**: 1 ASCII character (`W` or `N`).
- **Usage**:
  - Send the delimiter.
  - Send the command code `0x03`.
  - Send the parameters concatenated as a string.

**Parameter Details**:

| Parameter             | Length | Description                                          |
|-----------------------|--------|------------------------------------------------------|
| Transmit Frequency    | 8      | Frequency in MHz (e.g., `146.5200`)                  |
| Receive Frequency     | 8      | Frequency in MHz                                     |
| Tone                  | 2      | CTCSS tone frequency code (`00` for none)            |
| Squelch               | 1      | `0` through `8` (off through maximum squelch)        |
| Bandwidth             | 1      | `W` or `N` (wide 25kHz or narrow 12.5kHz)            |

### 3.4. COMMAND_FILTERS (0x04)

- **Description**: Configures the emphasis, high-pass, and low-pass filters.
- **Parameters**: 3 bytes.
  - Each byte is either `0` (disable) or `1` (enable).
  - Order: `[Emphasis][High-Pass][Low-Pass]`.
- **Usage**:
  - Send the delimiter.
  - Send the command code `0x04`.
  - Send the 3-byte parameter string.

### 3.5. COMMAND_STOP (0x05)

- **Description**: Stops all operations and resets the device to standby mode, waiting for the next command.
- **Parameters**: None.
- **Usage**:
  - Send the delimiter.
  - Send the command code `0x05`.

### 3.6. COMMAND_GET_FIRMWARE_VER (0x06)

- **Description**: Requests the firmware version from the device.
- **Parameters**: None.
- **Response**: The device will send back the string `VERSION` followed by an 8-character firmware version (e.g., `00000002`).
- **Usage**:
  - Send the delimiter.
  - Send the command code `0x06`.

---

## 4. Commands from ESP32 (to Android)

These commands may be sent by the ESP32 firmware, often embedded in the audio stream. Like the Android to ESP32 commands, these are prefixed with the same delimiter. 
However, since these commands are embedded in an audio stream, they also include a count of parameter bytes. The overall format is:

DELIMITER + COMMAND BYTE + PARAM SIZE BYTE + PARAM BYTE(S)

Since the param size is stored in a byte, params can have a maximum of 255 bytes.

### 4.1. COMMAND_SMETER (0x53)

This command reports how strong the current signal reception (RSSI) is, from 0-255. It is sent periodically by the firmware to the Android device, via the audio stream.

## 5. Examples

### 5.1. Changing Frequencies

**Objective**: Set the transmit frequency to `146.5200` MHz, receive frequency to `146.5200` MHz, no tone, squelch off, and wide bandwidth.

**Command Sequence**:

1. **Delimiter**:

   ```plaintext
   0xFF 0x00 0xFF 0x00 0xFF 0x00 0xFF 0x00
   ```

2. **Command Code**:

   ```plaintext
   0x03 (COMMAND_TUNE_TO)
   ```

3. **Parameters**:

   - Transmit Frequency: `146.5200` (ASCII)
   - Receive Frequency: `146.5200` (ASCII)
   - Tone: `00` (ASCII)
   - Squelch: `0` (ASCII)
   - Bandwidth: `W` (ASCII)

**Full Byte Sequence** (in hexadecimal):

```plaintext
FF 00 FF 00 FF 00 FF 00 03 31 34 36 2E 35 32 30 30 31 34 36 2E 35 32 30 30 30 30 30 57
```

**Explanation**:

- `31 34 36 2E 35 32 30 30` is ASCII for `146.5200`.
- Tone `00`: `30 30`.
- Squelch `0`: `30`.
- Bandwidth `W`: `57`

### 5.2. Starting Transmission

**Objective**: Begin transmitting audio data.

**Command Sequence**:

1. **Delimiter**:

   ```plaintext
   0xFF 0x00 0xFF 0x00 0xFF 0x00 0xFF 0x00
   ```

2. **Command Code**:

   ```plaintext
   0x01 (COMMAND_PTT_DOWN)
   ```

**Following Data**:

- Send the audio data bytes immediately after the command.
- Audio data should be raw 8-bit PCM audio sampled at **22050Hz**.

### 5.3. Stopping Transmission

**Objective**: Stop transmitting and return to receive mode.

**Command Sequence**:

1. **While in transmission mode**, send the delimiter and the `COMMAND_PTT_UP` code.

   ```plaintext
   0xFF 0x00 0xFF 0x00 0xFF 0x00 0xFF 0x00 0x02
   ```

**Note**: There may be a brief delay (~40 ms) to allow final audio data to be transmitted.

### 5.4. Configuring Filters

**Objective**: Enable emphasis and disable high-pass and low-pass filters.

**Command Sequence**:

1. **Delimiter**:

   ```plaintext
   0xFF 0x00 0xFF 0x00 0xFF 0x00 0xFF 0x00
   ```

2. **Command Code**:

   ```plaintext
   0x04 (COMMAND_FILTERS)
   ```

3. **Parameters**:

   - Emphasis: `1`
   - High-Pass: `0`
   - Low-Pass: `0`

**Full Byte Sequence** (in hexadecimal):

```plaintext
FF 00 FF 00 FF 00 FF 00 04 31 30 30
```

### 5.5. Retrieving Firmware Version

**Objective**: Get the firmware version from the device.

**Command Sequence**:

1. **Delimiter**:

   ```plaintext
   0xFF 0x00 0xFF 0x00 0xFF 0x00 0xFF 0x00
   ```

2. **Command Code**:

   ```plaintext
   0x06 (COMMAND_GET_FIRMWARE_VER)
   ```

**Expected Response**:

- The device will send back `VERSION00000002` (assuming the firmware version is `00000002`).

---

## 6. Additional Notes

- **Audio Data Format**:
  - When transmitting (after `COMMAND_PTT_DOWN`), send raw 8-bit PCM audio data sampled at **22050Hz**.
  - Ensure continuous data flow to prevent underruns or audio glitches.

- **Runaway Transmission Prevention**:
  - The device has a built-in safeguard that limits continuous transmission to **200 seconds** to prevent unintended prolonged transmissions.

- **Squelch Behavior**:
  - When in receive mode, the device handles squelch transitions smoothly using fade-in and fade-out effects to prevent audio pops.

- **Buffer Sizes**:
  - The device uses internal buffers to manage audio data. Avoid sending data exceeding buffer capacities in a single burst.

- **Watchdog Timer (WDT)**:
  - The device resets its watchdog timer regularly. If unresponsive, it may automatically reboot to recover from potential lock-ups.

- **Error Handling**:
  - Unexpected commands or malformed data may be ignored. Ensure that commands and parameters are correctly formatted according to the protocol.

---

**Disclaimer**: Always test commands in a controlled environment to prevent unintended behavior. This documentation assumes familiarity with serial communication protocols and the KV4P-HT device's operational context.
